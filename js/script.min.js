var channelName="groupChat",historyDate="",historyMonth="",messageValue=document.getElementById("message"),monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],pageProtocol="https",person="",receivingMessage=document.getElementById("receiving-messages"),typingStatus=document.getElementById("typing-status"),userDetails={},cookieExpire=(new Date).getFullYear()+1;function getCookie(e){"use strict";for(var t=e+"=",s=document.cookie.split(";"),n="",i=0;i<s.length;){for(n=s[i],i+=1;" "==n.charAt(0);)n=n.substring(1);if(0==n.indexOf(t))return n.substring(t.length,n.length)}return""}var uuid=getCookie("name");""!==uuid?alert("Welcome again "+uuid):(person=prompt("Please enter your name:",""),uuid=null==person||""==person?"random-generated-"+Math.floor(1e5*Math.random()):person,document.cookie="name="+uuid+"; expires="+cookieExpire+";"),"http:"===window.location.protocol&&(pageProtocol="http"),$.get(pageProtocol+"://ipinfo.io",function(e){"use strict";userDetails.ip=e.ip,userDetails.city=e.city,userDetails.region=e.region,userDetails.country=e.country,userDetails.loc=e.loc},"jsonp"),document.addEventListener("DOMContentLoaded",function(){"use strict";"granted"!==Notification.permission&&Notification.requestPermission()});var PubNub=new PubNub({publishKey:"pub-c-8a0d91c5-986f-425c-a9b6-f9cceaaa79f8",subscribeKey:"sub-c-7a30f168-357d-11e7-887b-02ee2ddab7fe",uuid:uuid});function messageNotification(e,t){"use strict";if(Notification)if("granted"!==Notification.permission)Notification.requestPermission(function(s){if("granted"===s){var n=new Notification(e+" says",{icon:"icons/favicon.png",body:t});n.onshow=function(){setTimeout(function(){n.close()},1e4)}}});else{var s=new Notification(e+" says",{icon:"icons/favicon.png",body:t});s.onshow=function(){setTimeout(function(){s.close()},1e4)},s.onclick=function(){window.focus(window.location.href),s.close()}}else alert("Desktop notifications not available in your browser.")}function sendMessage(){"use strict";if(messageValue.value){var e={text:messageValue.value,uuid:uuid,timestamp:Date.now()};userDetails.ip&&(e.ip=userDetails.ip),userDetails.city&&(e.city=userDetails.city),userDetails.region&&(e.region=userDetails.region),userDetails.country&&(e.country=userDetails.country),userDetails.loc&&(e.loc=userDetails.loc),PubNub.publish({message:e,channel:channelName,storeInHistory:!0,ttl:24}),PubNub.setState({state:{isTyping:!1},channels:[channelName]},function(e,t){e.error?console.log(e):typingStatus.innerHTML=""}),messageValue.value=""}}function typeMessage(e){"use strict";var t=!0;if(messageValue.value){if(messageValue.value.length<1||8===e.keyCode&&messageValue.value.length<=1)t=!1;else if(13===e.keyCode)return void sendMessage();PubNub.setState({state:{isTyping:t},channels:[channelName]},function(e,t){e.error&&console.log(e)})}}PubNub.history({channel:channelName,count:15},function(e,t){"use strict";receivingMessage.innerHTML=t.messages.map(function(e){var t=new Date(e.entry.timestamp),s=t.getDate(),n=monthNames[t.getMonth()],i=t.getFullYear(),a=t.getHours(),o="0"+t.getMinutes(),u="0"+t.getSeconds(),r="";historyDate!=s&&historyMonth!=n&&(historyDate=s,historyMonth=n,r="<div class='datetime'>"+n+" "+s+", "+i+"</div>");var c=a+":"+o.substr(-2)+":"+u.substr(-2),l="";return e.entry.city&&(l=e.entry.city),e.entry.country&&(l=""===l?e.entry.country:l+", "+e.entry.country),r+"<div><span>"+e.entry.uuid+"</span><span class='location'>"+l+"</span><span class='message'>"+e.entry.text+"</span><span class='timestamp'>"+c+"</span></div>"}).join(""),receivingMessage.scrollTop=receivingMessage.scrollHeight}),PubNub.addListener({message:function(e){"use strict";var t=new Date(e.message.timestamp),s=t.getDate(),n=monthNames[t.getMonth()],i=t.getFullYear(),a=t.getHours(),o="0"+t.getMinutes(),u="0"+t.getSeconds(),r="";historyDate!=s&&historyMonth!=n&&(historyDate=s,historyMonth=n,r="<div class='datetime'>"+n+" "+s+", "+i+"</div>");var c="";e.message.city&&(c=e.message.city),e.message.country&&(c=""===c?e.message.country:c+", "+e.message.country);var l=a+":"+o.substr(-2)+":"+u.substr(-2);receivingMessage.innerHTML+=r+"<div><span>"+e.publisher+": </span><span class='location'>"+c+"</span><span class='message'>"+e.message.text+"</span><span class='timestamp'>"+l+"</span></div>",uuid!=e.publisher&&messageNotification(e.publisher,e.message.text),receivingMessage.scrollTop=receivingMessage.scrollHeight},presence:function(e){"use strict";if(PubNub.getUUID()!=e.uuid&&e.state.isTyping)""==typingStatus.innerHTML?typingStatus.innerHTML=e.uuid+" is Typing":typingStatus.innerHTML+=", "+e.uuid+" is Typing";else if(PubNub.getUUID()!=e.uuid&&!e.state.isTyping){var t=typingStatus.innerHTML;t===", "+e.uuid+" is Typing"?typingStatus.innerHTML="":t.includes(e.uuid+" is Typing, ")?typingStatus.innerHTML=t.replace(e.uuid+" is Typing, ",""):typingStatus.innerHTML=t.replace(e.uuid+" is Typing","")}}}),PubNub.subscribe({channels:[channelName],withPresence:!0}),document.getElementById("send-message").addEventListener("click",sendMessage),document.getElementById("message").addEventListener("keydown",typeMessage);
